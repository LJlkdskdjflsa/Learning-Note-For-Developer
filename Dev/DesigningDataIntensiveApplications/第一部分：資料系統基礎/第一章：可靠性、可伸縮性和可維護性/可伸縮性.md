### 可伸縮性
系統今天能可靠執行，並不意味未來也能可靠執行。
服務降級（degradation） 的一個常見原因是負載增加
例如：系統負載已經從一萬個併發使用者增長到十萬個併發使用者。也許現在處理的資料量級要比過去大得多。

可伸縮性（Scalability）是用來描述系統應對負載增長能力的術語。
討論可伸縮性意味著考慮以下問題
- 如果系統以特定方式增長，有什麼選項可以應對增長？
- 如何增加計算資源來處理額外的負載？ 

設計可伸縮性的應用可分為以下階段：
- 描述負載
- 描述效能
- 應對負載的方法

#### 描述負載
在討論增長問題（如果負載加倍會發生什麼？）前，首先要能描述系統的當前負載。
負載可以用 負載引數（load parameters）來量化描述。
引數的最佳選擇取決於系統架構，它可能是每秒向 Web 伺服器發出的請求、資料庫中的讀寫比率、聊天室中同時活躍的使用者數量、快取命中率或其他東西。
除此之外，也許平均情況對你很重要，也許你的瓶頸是少數極端場景。

##### 範例：推特

推特的兩個主要業務是：
- 釋出推文
  - 使用者可以向其粉絲釋出新訊息（平均 4.6k 請求 / 秒，峰值超過 12k 請求 / 秒）。
- 主頁時間線
  - 使用者可以查閱他們關注的人釋出的推文（300k 請求 / 秒）。

處理每秒 12,000 次寫入（發推文的速率峰值）還是很簡單的。然而推特的伸縮性挑戰並不是主要來自推特量，而是來自 扇出（fan-out）—— 每個使用者關注了很多人，也被很多人關注。

> 扇出：從電子工程學中借用的術語，它描述了輸入連線到另一個門輸出的邏輯閘數量。 輸出需要提供足夠的電流來驅動所有連線的輸入。 
> 在事務處理系統中，我們使用它來描述為了服務一個傳入請求而需要執行其他服務的請求數量。

#### 描述效能
研究當負載增加會發生什麼。可以從兩種角度來看：
- 增加負載引數,保持系統資源不變時，系統性能將受到什麼影響？
- 增加負載引數,並保持效能不變時，需要增加多少系統資源？

這兩個問題都需要效能資料，所以讓我們簡單地看一下如何描述系統性能
- 批處理系統(ex.Hadoop)
  - 吞吐量（throughput）(每秒可以處理的記錄數量)
- 線上系統
  - 響應時間（response time）(客戶端傳送請求到接收響應之間的時間)

> 批次作業的執行時間是資料集的大小除以吞吐量。 在實踐中由於資料傾斜（資料不是均勻分佈在每個工作程序中），需要等待最慢的任務完成，所以執行時間往往更長。

##### 延遲 vs 響應時間
- 延遲（latency）
- 響應時間（response time）

響應時間是客戶所看到的，除了實際處理請求的時間（ 服務時間（service time） ）之外，還包括網路延遲和排隊延遲。延遲是某個請求等待處理的 持續時長，在此期間它處於 休眠（latent） 狀態，並等待服務

響應時間應視為一個可以測量的數值 分佈（distribution），而不是單個數值。

##### 請求
大多數請求是相當快的，但偶爾會出現需要更長的時間的異常值。這也許是因為緩慢的請求實質上開銷更大，例如它們可能會處理更多的資料。但即使（你認為）所有請求都花費相同時間的情況下，隨機的附加延遲也會導致結果變化
例如：
- 上下文切換到後臺程序
- 網路資料包丟失與 TCP 重傳
- 垃圾收集暫停
- 強制從磁碟讀取的頁面錯誤
- 伺服器機架中的震動

###### 檢視請求時間
通常報表都會展示服務的平均(算術平均)響應時間
如果你想知道 “典型（typical）” 響應時間，那麼平均值並不是一個非常好的指標，因為它不能告訴你有多少使用者實際上經歷了這個延遲。

使用 百分位點（percentiles） 會更好。如果將響應時間列表按最快到最慢排序，那麼 中位數（median） 就在正中間：舉個例子，如果你的響應時間中位數是 200 毫秒，這意味著一半請求的返回時間少於 200 毫秒，另一半比這個要長。

為了弄清異常值有多糟糕，可以看看更高的百分位點，例如第 95、99 和 99.9 百分位點（縮寫為 p95，p99 和 p999）。它們意味著 95%、99% 或 99.9% 的請求響應時間要比該閾值快，例如：如果第 95 百分位點響應時間是 1.5 秒，則意味著 100 個請求中的 95 個響應時間快於 1.5 秒，而 100 個請求中的 5 個響應時間超過 1.5 秒。

響應時間的高百分位點（也稱為 尾部延遲，即 tail latencies）非常重要，因為它們直接影響使用者的服務體驗。例如亞馬遜在描述內部服務的響應時間要求時是以 99.9 百分位點為準，即使它隻影響一千個請求中的一個。這是因為請求響應最慢的客戶往往也是資料最多的客戶，也可以說是最有價值的客戶
百分位點通常用於 服務級別目標（SLO, service level objectives） 和 服務級別協議（SLA, service level agreements），即定義服務預期效能和可用性的合同。 SLA 可能會宣告，如果服務響應時間的中位數小於 200 毫秒，且 99.9 百分位點低於 1 秒，則認為服務工作正常（如果響應時間更長，就認為服務不達標）。

###### 排隊延遲（queueing delay） 
排隊延遲通常佔了高百分位點處響應時間的很大一部分。由於伺服器只能並行處理少量的事務（如受其 CPU 核數的限制），所以只要有少量緩慢的請求就能阻礙後續請求的處理，這種效應有時被稱為 頭部阻塞（head-of-line blocking） 。即使後續請求在伺服器上處理的非常迅速，由於需要等待先前請求完成，客戶端最終看到的是緩慢的總體響應時間。因為存在這種效應，測量客戶端的響應時間非常重要。

為測試系統的可伸縮性而人為產生負載時，產生負載的客戶端要獨立於響應時間不斷傳送請求。如果客戶端在傳送下一個請求之前等待先前的請求完成，這種行為會產生人為排隊的效果，使得測試時的佇列比現實情況更短，使測量結果產生偏差。

當一個請求需要多個後端請求時，單個後端慢請求就會拖慢整個終端使用者的請求

#### 應對負載的方法
當負載引數增加時，如何保持良好的效能？

適應某個級別負載的架構不太可能應付 10 倍於此的負載。
那麼每次負載發生數量級的增長時，都需要重新考慮架構，或者更頻繁。

- 縱向伸縮（scaling up，也稱為垂直伸縮，即 vertical scaling，轉向更強大的機器）
- 橫向伸縮（scaling out，也稱為水平伸縮，即 horizontal scaling，將負載分佈到多臺小機器上）

現實世界中的優秀架構需要將這兩種方法務實地結合

- 彈性（elastic）的系統
  - 可以在檢測到負載增加時自動增加計算資源
  - 如果負載 極難預測（highly unpredictable），則彈性系統可能很有用，但手動伸縮系統更簡單，並且意外操作可能會更少

跨多臺機器部署 無狀態服務（stateless services）非常簡單，但將帶狀態的資料系統從單節點變為分散式配置則可能引入許多額外複雜度。->應該將資料庫放在單個節點上（縱向伸縮），直到伸縮成本或可用性需求迫使其改為分散式。

隨著分散式系統的工具和抽象越來越好，至少對於某些型別的應用而言，這種常識可能會改變。
可以預見分散式資料系統將成為未來的預設設定，即使對不處理大量資料或流量的場景也如此。

大規模的系統架構通常是應用特定的
應用的問題可能在於
- 讀取量
- 寫入量
- 要儲存的資料量
- 資料的複雜度
- 響應時間要求
- 訪問模式
